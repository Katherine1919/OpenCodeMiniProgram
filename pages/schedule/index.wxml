<view class="app-bg schedule-page">
  <view class="custom-header" style="height:{{headerHeight}}px;">
    <view class="custom-header-inner" style="padding-top:{{statusBarHeight}}px;height:88rpx;">
      <text class="custom-header-title">排程</text>
    </view>
  </view>
  <view class="page-container" style="padding-top:{{headerHeight}}px;">
    <view class="hero glass-card mb-4">
      <text class="text-title">排程</text>
      <text class="text-helper text-muted mt-1" style="display:block;">把可用时间先放好</text>
    </view>

    <view class="section-title mb-3">可用时间模板</view>
    <view class="template-list mb-4">
      <view wx:for="{{templates}}" wx:key="id" class="template-card glass-card">
        <view class="template-info">
          <text class="text-body">{{item.start}} - {{item.end}}</text>
          <text class="text-helper text-muted">{{item.label}}</text>
        </view>
        <view class="template-actions">
          <view class="pill-mini" bindtap="editTemplate" data-id="{{item.id}}">编辑</view>
          <view class="pill-mini" bindtap="deleteTemplate" data-id="{{item.id}}">移除</view>
        </view>
      </view>
    </view>

    <view wx:if="{{showAddForm}}" class="form-card glass-card mb-4">
      <view class="form-row">
        <input class="form-input" type="text" placeholder="开始时间 (如 0900)" value="{{rawFormStart}}" bindinput="onStartInput" />
      </view>
      <view class="form-row">
        <input class="form-input" type="text" placeholder="结束时间 (如 1200)" value="{{rawFormEnd}}" bindinput="onEndInput" />
      </view>
      <view class="form-row">
        <input class="form-input" placeholder="标签(可选)" value="{{formLabel}}" bindinput="onLabelInput" />
      </view>
      <view class="form-actions">
        <view class="form-btn form-btn-ghost" bindtap="cancelAdd">取消</view>
        <view class="form-btn form-btn-primary" bindtap="saveTemplate">保存</view>
      </view>
    </view>

    <view wx:if="{{!showAddForm}}" class="secondary-btn mb-4" bindtap="showAdd">添加时间模板</view>

    <view class="cta-section mb-4">
      <view class="secondary-btn" bindtap="generateToday">重新生成排程</view>
    </view>

    <view wx:if="{{schedulePreview.length > 0}}" class="schedule-list">
      <view class="section-title mb-3">今日排程预览</view>
      <view class="timeline">
        <view wx:for="{{schedulePreview}}" wx:key="id" class="timeline-row schedule-row">
          <view class="time-col">{{item.start}}</view>
          <view class="line-col timeline-col">
            <view class="timeline-dot"></view>
            <view wx:if="{{index < schedulePreview.length - 1}}" class="timeline-connector"></view>
          </view>
          <view class="task-card glass-card card" wx:if="{{item.kind === 'task'}}">
            <view class="task-header card-title">
              <text class="text-body">{{item.title}}</text>
              <view wx:if="{{item.conflict}}" class="status-tag conflict-tag chip chip-danger">冲突</view>
            </view>
            <text class="text-helper text-muted mt-1 card-time" style="display:block;">
              {{item.start}}–{{item.end}}
            </text>
          </view>
          <view class="break-card" wx:else>
            <text class="text-helper text-muted">— 休息 —</text>
          </view>
        </view>
        <view class="list-bottom-spacer"></view>
      </view>
    </view>
  </view>
</view>
